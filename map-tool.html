<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>μ£Όμ†β†’μΆν‘ (κµ¬μ£Όμ†+λ„λ΅λ… λ¨λ‘ μ§€μ›)</title>
</head>
<body>
<h1>π“ μ£Όμ† β†’ μΆν‘ λ³€ν™</h1>
<input id="address" placeholder="λ„λ΅λ… λλ” κµ¬μ£Όμ† λ¨λ‘ OK (μ: μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ ν…ν—¤λ€λ΅ 123 λλ” μ—­μ‚Όλ™ 123-45)" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;">
<button onclick="findCoords()" style="width:100%;padding:12px;font-size:16px;background:#03c75a;color:white;border:none;margin:10px 0;cursor:pointer;">π” μΆν‘ μ°ΎκΈ° & λ³µμ‚¬</button>
<div id="result" style="display:none;padding:15px;background:#f0f9f4;border-left:4px solid #03c75a;">
  <strong>β… μΆν‘ λ³µμ‚¬ μ™„λ£!</strong><br>
  <div id="coords" style="background:#333;color:#0f0;padding:12px;font-family:monospace;border-radius:4px;margin-top:10px;"></div>
</div>

<script>
const cache = new Map();

async function findCoords() {
  const address = document.getElementById('address').value.trim();
  if (!address) return alert('μ£Όμ†λ¥Ό μ…λ ¥ν•μ„Έμ”!');
  
  const btn = document.querySelector('button');
  btn.disabled = true;
  btn.innerHTML = 'β³ κ²€μƒ‰μ¤‘...';
  
  // μΊμ‹ ν™•μΈ
  if (cache.has(address)) {
    showResult(cache.get(address));
    btn.disabled = false;
    btn.innerHTML = 'π” μΆν‘ μ°ΎκΈ° & λ³µμ‚¬';
    return;
  }
  
  try {
    // π”¥ κµ¬μ£Όμ†+λ„λ΅λ… λ¨λ‘ μ§€μ›ν•λ” μµμ ν™”λ νλΌλ―Έν„°
    const apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=3&countrycodes=kr&addressdetails=1&viewbox=126.5,37.4,127.2,38.0&bounded=1`;
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 4000);
    
    const response = await fetch(apiUrl, {
      signal: controller.signal,
      headers: { 
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json'
      }
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) throw new Error('λ„¤νΈμ›ν¬ μ¤λ¥');
    
    const data = await response.json();
    
    if (data && data.length > 0) {
      // κ°€μ¥ μ •ν™•ν• κ²°κ³Ό μ„ νƒ (λ„λ΅λ… μ°μ„  β†’ κµ¬μ£Όμ†)
      const bestMatch = data.find(item => 
        item.address.road || 
        item.address.suburb || 
        item.address.neighbourhood || 
        item.type === 'house'
      ) || data[0];
      
      const lat = parseFloat(bestMatch.lat);
      const lng = parseFloat(bestMatch.lon);
      const coordsText = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      
      cache.set(address, coordsText);
      showResult(coordsText);
      
    } else {
      throw new Error('μ£Όμ† μ°ΎκΈ° μ‹¤ν¨');
    }
    
  } catch (error) {
    if (error.name === 'AbortError') {
      alert('β±οΈ κ²€μƒ‰μ‹κ°„ μ΄κ³Ό\nλ” μ •ν™•ν• μ£Όμ†λ΅ μ…λ ¥');
    } else {
      alert('β μ£Όμ† μ°ΎκΈ° μ‹¤ν¨\n\nλ„λ΅λ…μ£Όμ† μ°μ„  κ¶μ¥:\n"μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ ν…ν—¤λ€λ΅ 123"\n\nκµ¬μ£Όμ†λ„ κ°€λ¥:\n"μ„μΈμ‹ κ°•λ‚¨κµ¬ μ—­μ‚Όλ™ 123-45"');
    }
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'π” μΆν‘ μ°ΎκΈ° & λ³µμ‚¬';
  }
}

function showResult(coordsText) {
  navigator.clipboard.writeText(coordsText).then(() => {
    document.getElementById('coords').textContent = coordsText;
    document.getElementById('result').style.display = 'block';
    document.getElementById('result').scrollIntoView({behavior: 'smooth'});
  });
}

// URL νλΌλ―Έν„° μλ™ μ‹¤ν–‰
const urlParams = new URLSearchParams(location.search);
const addr = urlParams.get('address');
if (addr) {
  document.getElementById('address').value = decodeURIComponent(addr);
  setTimeout(findCoords, 500);
}

document.getElementById('address').addEventListener('keypress', e => {
  if (e.key === 'Enter') findCoords();
});
</script>
</body>
</html>
